<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>전시 지도</title>
  <!-- Tailwind CSS CDN을 추가하여 UI를 깔끔하게 만듭니다. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>
  
  <!-- Kakao Map SDK 스크립트 태그는 이제 HTML에서 직접 제거됩니다.
       대신 JavaScript에서 동적으로 생성하여 로드할 것입니다. -->

  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      font-family: 'Inter', sans-serif; /* Tailwind의 Inter 폰트 사용 */
    }
    #map { 
      width: 100%; 
      height: 100%; 
      border-radius: 16px; /* 둥근 모서리 적용 */
      overflow: hidden; /* 둥근 모서리 내부 콘텐츠 클리핑 */
    }
    #moveCurrent {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: white;
      border-radius: 50%;
      padding: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.4); /* 그림자 효과 강화 */
      cursor: pointer;
      z-index: 10;
      display: flex; /* 아이콘 중앙 정렬 */
      align-items: center;
      justify-content: center;
      transition: transform 0.2s; /* 호버 애니메이션 */
    }
    #moveCurrent:active {
      transform: scale(0.95); /* 클릭 시 스케일 축소 */
    }
    /* 커스텀 메시지 박스 스타일 */
    .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        text-align: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    .message-box.show {
        opacity: 1;
        visibility: visible;
    }
  </style>
</head>
<body>
  <!-- messageBox 요소를 스크립트보다 먼저 정의하여 스크립트에서 접근 가능하도록 합니다. -->
  <div id="messageBox" class="message-box"></div> 
  <div id="map"></div>
  <div id="moveCurrent" onclick="moveToCurrentLocation()">
    <!-- 구글 아이콘을 SVG로 직접 포함하여 외부 의존성 제거 및 스타일링 유연성 확보 -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="text-gray-700">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
  </div>

  <script>
    let map;
    let currentPos = null;
    let ps;
    let messageBox; // 메시지 박스 요소 변수 선언

    // DOMContentLoaded 이벤트 리스너를 추가하여 DOM이 완전히 로드된 후 messageBox를 초기화합니다.
    document.addEventListener('DOMContentLoaded', () => {
        messageBox = document.getElementById('messageBox');
        if (!messageBox) {
            console.error("[KakaoMap HTML] messageBox element not found after DOMContentLoaded.");
        }
    });

    // 메시지를 표시하는 함수
    function showMessage(message, duration = 3000) {
        if (!messageBox) {
            console.error("[KakaoMap HTML] showMessage called but messageBox is null.");
            return; // messageBox가 없으면 메시지를 표시할 수 없습니다.
        }
        messageBox.textContent = message;
        messageBox.classList.add('show');
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, duration);
    }

    // Flutter에서 호출되어 Kakao Map API 키를 주입하고 지도를 초기화하는 함수
    function injectKakaoMapKeyAndLoadMap(appkey) {
      console.log("[KakaoMap HTML] injectKakaoMapKeyAndLoadMap called with key (first 5 chars):", appkey.substring(0, 5)); // 보안을 위해 키 전체를 로깅하지 않습니다.
      
      // 기존에 로드된 Kakao Map SDK 스크립트가 있다면 제거 (중복 로드 방지)
      const existingScript = document.getElementById('kakao-map-sdk-script');
      if (existingScript) {
          existingScript.remove();
          console.log("[KakaoMap HTML] Removed existing Kakao Map SDK script.");
      }

      // 새로운 스크립트 요소 생성
      const script = document.createElement('script');
      script.id = 'kakao-map-sdk-script'; // ID를 부여하여 나중에 참조할 수 있도록 합니다.
      script.type = 'text/javascript';
      script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${appkey}&libraries=services&autoload=false`;
      script.async = true; // 비동기 로드 설정
      console.log("[KakaoMap HTML] Dynamically created Kakao Map SDK script with src:", script.src);
      
      script.onload = () => {
        console.log("[KakaoMap HTML] Kakao Map SDK loaded successfully. Calling kakao.maps.load...");
        kakao.maps.load(() => {
          console.log("[KakaoMap HTML] kakao.maps.load callback fired. Initializing map...");
          initKakaoMap(); // SDK 로드 완료 후 지도 초기화 함수 호출
        });
      };
      script.onerror = (e) => {
          console.error("[KakaoMap HTML] Failed to load Kakao Map SDK:", e);
          showMessage("카카오 맵 SDK 로드에 실패했습니다. 네트워크를 확인해주세요.");
      };

      // 스크립트를 문서의 head에 추가하여 로드를 시작합니다.
      document.head.appendChild(script);
      console.log("[KakaoMap HTML] Appended Kakao Map SDK script to document head.");
    }

    // Kakao Map 초기화 및 위치 정보 가져오기 로직
    function initKakaoMap() {
      console.log("[KakaoMap HTML] initKakaoMap called.");
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
          console.error("[KakaoMap HTML] Map container element (id='map') not found!");
          showMessage("지도를 표시할 영역을 찾을 수 없습니다.");
          return;
      }
      const mapOptions = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청 기본 위치
        level: 5
      };
      map = new kakao.maps.Map(mapContainer, mapOptions);
      ps = new kakao.maps.services.Places();
      console.log("[KakaoMap HTML] Kakao Map and Places service initialized.");

      if (navigator.geolocation) {
        console.log("[KakaoMap HTML] Geolocation supported. Attempting to get current position...");
        navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, {
          enableHighAccuracy: true,
          maximumAge: 300000, // 5분 이내 캐시된 위치 정보는 재사용
          timeout: 30000 // 30초 내에 응답 없으면 타임아웃
        });
      } else {
        console.error('[KakaoMap HTML] This browser does not support geolocation.');
        showMessage('현재 브라우저에서는 위치 정보를 지원하지 않습니다.');
      }
    }

    function onLocationSuccess(position) {
      console.log("[KakaoMap HTML] Geolocation success. Lat:", position.coords.latitude, "Lon:", position.coords.longitude);
      currentPos = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
      map.setCenter(currentPos);

      new kakao.maps.Marker({
        map,
        position: currentPos,
        title: '현재 위치',
        image: new kakao.maps.MarkerImage(
          'https://cdn-icons-png.flaticon.com/512/684/684908.png', // 더 일반적인 위치 아이콘
          new kakao.maps.Size(30, 30),
          { offset: new kakao.maps.Point(15, 15) }
        )
      });
      console.log("[KakaoMap HTML] Current location marker added.");

      searchNearbyExhibitions(position.coords.latitude, position.coords.longitude);
    }

    function onLocationError(error) {
      let message = '';
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = '위치 권한이 거부되었습니다. 앱 설정에서 권한을 허용해주세요.';
          break;
        case error.POSITION_UNAVAILABLE:
          message = '기기의 위치 정보를 사용할 수 없습니다. (GPS 비활성화 등)';
          break;
        case error.TIMEOUT:
          message = '위치 요청 시간이 초과되었습니다. 네트워크 상태를 확인해주세요.';
          break;
        default:
          message = `알 수 없는 위치 오류입니다. 코드: ${error.code}`;
      }
      console.error(`[KakaoMap HTML] Geolocation error (${error.code}): ${error.message} - ${message}`);
      showMessage(`현재 위치를 가져올 수 없습니다.\n사유: ${message}`);
    }

    function searchNearbyExhibitions(lat, lon) {
      console.log("[KakaoMap HTML] Searching nearby exhibitions around Lat:", lat, "Lon:", lon);
      ps.keywordSearch('전시', (data, status, pagination) => {
        if (status === kakao.maps.services.Status.OK) {
          console.log("[KakaoMap HTML] Exhibition search successful. Found", data.length, "places.");
          data.forEach(place => {
            const marker = new kakao.maps.Marker({
              map,
              position: new kakao.maps.LatLng(place.y, place.x),
              title: place.place_name,
              image: new kakao.maps.MarkerImage(
                'https://cdn-icons-png.flaticon.com/512/854/854878.png', // 전시회 아이콘
                new kakao.maps.Size(28, 28),
                { offset: new kakao.maps.Point(14, 14) }
              )
            });
            const infoWindow = new kakao.maps.InfoWindow({
              content: `<div style="padding:5px;font-size:13px;font-family: 'Inter', sans-serif;">${place.place_name}</div>`
            });
            kakao.maps.event.addListener(marker, 'click', () => {
              infoWindow.open(map, marker);
            });
          });
          if (data.length === 0) {
              console.log('[KakaoMap HTML] No exhibition places found nearby.');
              showMessage('현재 위치 근처에 전시 장소가 없습니다.');
          }
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
          console.log('[KakaoMap HTML] No exhibition places found nearby (ZERO_RESULT).');
          showMessage('근처에 전시 장소가 없습니다.');
        } else {
          console.error(`[KakaoMap HTML] Search error: ${status}`);
          showMessage(`전시 장소 검색 오류가 발생했습니다. 상태: ${status}`);
        }
      }, {
        location: new kakao.maps.LatLng(lat, lon),
        radius: 3000 // 3km 반경 내 검색
      });
    }

    // 현재 위치로 지도를 이동하는 함수
    function moveToCurrentLocation() {
      if (currentPos) {
        map.setCenter(currentPos);
        showMessage('현재 위치로 이동했습니다.');
        console.log("[KakaoMap HTML] Moved map to current location.");
      } else {
        console.error('[KakaoMap HTML] Cannot move to current location: currentPos is null.');
        showMessage('현재 위치를 불러올 수 없습니다.');
      }
    }
  </script>
</body>
</html>
