<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>전시 지도</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4e3d5fd0af4f53faefab49b87d79a11d&libraries=services&autoload=false"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    #moveCurrent {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: white;
      border-radius: 50%;
      padding: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="moveCurrent" onclick="moveToCurrentLocation()">
    <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" width="20" height="20" />
  </div>

  <script>
    let map;
    let currentPos = null;
    let ps;

    kakao.maps.load(() => {
      const mapContainer = document.getElementById('map');
      const mapOptions = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 5
      };
      map = new kakao.maps.Map(mapContainer, mapOptions);
      ps = new kakao.maps.services.Places();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, {
          enableHighAccuracy: true,
          maximumAge: 60000,
          timeout: 20000
        });
      } else {
        alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
      }
    });

    function onLocationSuccess(position) {
      currentPos = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
      map.setCenter(currentPos);

      new kakao.maps.Marker({
        map,
        position: currentPos,
        title: '현재 위치',
        image: new kakao.maps.MarkerImage(
          'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
          new kakao.maps.Size(24, 35)
        )
      });

      searchNearbyExhibitions(position.coords.latitude, position.coords.longitude);
    }

    function onLocationError(error) {
  let message = '';
  switch (error.code) {
    case 1:
      message = '위치 권한이 거부되었습니다.';
      break;
    case 2:
      message = '기기의 위치 정보를 사용할 수 없습니다.';
      break;
    case 3:
      message = '위치 요청이 시간 초과되었습니다.';
      break;
    default:
      message = '알 수 없는 위치 오류입니다.';
  }
  console.error(`위치 오류 (${error.code}): ${error.message}`);
  alert(`현재 위치를 가져올 수 없습니다.\n사유: ${message}`);
}

    function searchNearbyExhibitions(lat, lon) {
      ps.keywordSearch('전시', (data, status, pagination) => {
        if (status === kakao.maps.services.Status.OK) {
          data.forEach(place => {
            const marker = new kakao.maps.Marker({
              map,
              position: new kakao.maps.LatLng(place.y, place.x),
              title: place.place_name,
              image: new kakao.maps.MarkerImage(
                'https://cdn-icons-png.flaticon.com/512/854/854878.png',
                new kakao.maps.Size(28, 28),
                { offset: new kakao.maps.Point(14, 14) }
              )
            });
            const infoWindow = new kakao.maps.InfoWindow({
              content: `<div style="padding:5px;font-size:13px;">${place.place_name}</div>`
            });
            kakao.maps.event.addListener(marker, 'click', () => {
              infoWindow.open(map, marker);
            });
          });
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
          console.log('근처에 전시 장소가 없습니다.');
        } else {
          console.error('검색 오류:', status);
        }
      }, {
        location: new kakao.maps.LatLng(lat, lon),
        radius: 3000
      });
    }

    function moveToCurrentLocation() {
      if (currentPos) {
        map.setCenter(currentPos);
      } else {
        alert('현재 위치를 불러올 수 없습니다.');
      }
    }
  </script>
</body>
</html>
