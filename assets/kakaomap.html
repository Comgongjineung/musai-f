<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>전시 지도</title>
  <!-- Tailwind CSS CDN을 추가하여 UI를 깔끔하게 만듭니다. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>
  
  <!-- Kakao Map SDK 스크립트 태그는 이제 HTML에서 직접 제거됩니다.
       대신 JavaScript에서 동적으로 생성하여 로드할 것입니다. -->

  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      font-family: 'Inter', sans-serif; /* Tailwind의 Inter 폰트 사용 */
    }
    #map { 
      width: 100vw; 
      height: 100vh; 
      border-radius: 16px; /* 둥근 모서리 적용 */
      overflow: hidden; /* 둥근 모서리 내부 콘텐츠 클리핑 */
    }
    #moveCurrent {
      position: absolute;
      bottom: 4vh;
      right: 4vw;
      background: white;
      border-radius: 50%;
      padding: 2vw;
      box-shadow: 0 0 8px rgba(0,0,0,0.4); /* 그림자 효과 강화 */
      cursor: pointer;
      z-index: 10;
      display: flex; /* 아이콘 중앙 정렬 */
      align-items: center;
      justify-content: center;
      transition: transform 0.2s; /* 호버 애니메이션 */
    }
    #moveCurrent:active {
      transform: scale(0.95); /* 클릭 시 스케일 축소 */
    }
    /* 커스텀 메시지 박스 스타일 */
    .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 3vw 5vw;
        font-size: 3.5vw;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        text-align: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    .message-box.show {
        opacity: 1;
        visibility: visible;
    }
  </style>
</head>
<body>
  <!-- messageBox 요소를 스크립트보다 먼저 정의하여 스크립트에서 접근 가능하도록 합니다. -->
  <div id="messageBox" class="message-box"></div> 
  <div id="map"></div>
  <div id="moveCurrent" onclick="moveToCurrentLocation()">
    <!-- 구글 아이콘을 SVG로 직접 포함하여 외부 의존성 제거 및 스타일링 유연성 확보 -->
    <svg style="width: 8vw; height: 8vw;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="text-gray-700">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
  </div>

  <script>
    let map;
    let currentPos = null;
    let ps;
    let messageBox; // 메시지 박스 요소 변수 선언

    // DOMContentLoaded 이벤트 리스너를 추가하여 DOM이 완전히 로드된 후 messageBox를 초기화합니다.
    document.addEventListener('DOMContentLoaded', () => {
        messageBox = document.getElementById('messageBox');
        if (!messageBox) {
            console.error("[KakaoMap HTML] messageBox element not found after DOMContentLoaded.");
        }
    });

    // 메시지를 표시하는 함수
    function showMessage(message, duration = 3000) {
        if (!messageBox) {
            console.error("[KakaoMap HTML] showMessage called but messageBox is null.");
            return; // messageBox가 없으면 메시지를 표시할 수 없습니다.
        }
        messageBox.textContent = message;
        messageBox.classList.add('show');
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, duration);
    }

    // Flutter에서 호출되어 Kakao Map API 키를 주입하고 지도를 초기화하는 함수
    function injectKakaoMapKeyAndLoadMap(appkey) {
      //console.log("[KakaoMap HTML] injectKakaoMapKeyAndLoadMap 호출됨");
      //console.log("[KakaoMap HTML] injectKakaoMapKeyAndLoadMap called with key (first 5 chars):", appkey.substring(0, 5)); // 보안을 위해 키 전체를 로깅하지 않습니다.
      
      // 기존에 로드된 Kakao Map SDK 스크립트가 있다면 제거 (중복 로드 방지)
      const existingScript = document.getElementById('kakao-map-sdk-script');
      if (existingScript) {
          existingScript.remove();
      }

      // 새로운 스크립트 요소 생성
      const script = document.createElement('script');
      script.id = 'kakao-map-sdk-script'; // ID를 부여하여 나중에 참조할 수 있도록 합니다.
      script.type = 'text/javascript';
      script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${appkey}&libraries=services&autoload=false`;
      script.async = true; // 비동기 로드 설정
      //console.log("[KakaoMap HTML] Dynamically created Kakao Map SDK script with src:", script.src);
      
      script.onload = () => {
        kakao.maps.load(() => {
          console.log("[KakaoMap HTML] kakao.maps.load() 진입");
          //console.log("[KakaoMap HTML] kakao.maps.load callback fired. Initializing map...");
          initKakaoMap(); // SDK 로드 완료 후 지도 초기화 함수 호출
        });
      };
      script.onerror = (e) => {
          console.error("[KakaoMap HTML] Failed to load Kakao Map SDK:", e);
          showMessage("카카오 맵 SDK 로드에 실패했습니다. 네트워크를 확인해주세요.");
      };

      // 스크립트를 문서의 head에 추가하여 로드를 시작합니다.
      document.head.appendChild(script);
      //console.log("[KakaoMap HTML] Appended Kakao Map SDK script to document head.");
    }

    // Kakao Map 초기화 및 위치 정보 가져오기 로직
    function initKakaoMap() {
      console.log("[KakaoMap HTML] initKakaoMap called.");
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
          console.error("[KakaoMap HTML] Map container element (id='map') not found!");
          showMessage("지도를 표시할 영역을 찾을 수 없습니다.");
          return;
      }
      const mapOptions = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청 기본 위치
        level: 5
      };
      map = new kakao.maps.Map(mapContainer, mapOptions);
      ps = new kakao.maps.services.Places();
      //console.log("[KakaoMap HTML] Kakao Map and Places service initialized.");

      if (navigator.geolocation) {
        // Explicit permission query using Permissions API for debugging
        if (navigator.permissions) {
          navigator.permissions.query({ name: 'geolocation' }).then(function (result) {
            //console.log('[KakaoMap HTML] Geolocation permission state:', result.state);
          });
        }
        //console.log("[KakaoMap HTML] Geolocation supported. Attempting to get current position...");
        navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, {
          enableHighAccuracy: true,
          maximumAge: 300000, // 5분 이내 캐시된 위치 정보는 재사용
          timeout: 30000 // 30초 내에 응답 없으면 타임아웃
        });
      } else {
        //console.error('[KakaoMap HTML] This browser does not support geolocation.');
        showMessage('현재 브라우저에서는 위치 정보를 지원하지 않습니다.');
      }
    }

    let currentLocationMarker = null; // 현재 위치 마커 전역 변수 선언

function onLocationSuccess(position) {
  currentPos = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
  map.setCenter(currentPos);

  if (currentLocationMarker) {
    currentLocationMarker.setMap(null); // 기존 마커 제거
  }

  currentLocationMarker = new kakao.maps.Marker({
    map,
    position: currentPos,
    title: '현재 위치',
    image: new kakao.maps.MarkerImage(
      'https://cdn-icons-png.flaticon.com/512/684/684908.png',
      new kakao.maps.Size(50, 50),
      { offset: new kakao.maps.Point(15, 15) }
    )
  });

  searchNearbyExhibitions(position.coords.latitude, position.coords.longitude);
}

    function onLocationError(error) {
      let message = '';
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = '위치 권한이 거부되었습니다. 앱 설정에서 권한을 허용해주세요.';
          break;
        case error.POSITION_UNAVAILABLE:
          message = '기기의 위치 정보를 사용할 수 없습니다. (GPS 비활성화 등)';
          break;
        case error.TIMEOUT:
          message = '위치 요청 시간이 초과되었습니다. 네트워크 상태를 확인해주세요.';
          break;
        default:
          message = `알 수 없는 위치 오류입니다. 코드: ${error.code}`;
      }
      console.error(`[KakaoMap HTML] Geolocation error (${error.code}): ${error.message} - ${message}`);
      showMessage(`현재 위치를 가져올 수 없습니다.\n사유: ${message}`);
    }

    //근처 전시회 api 호출
    function searchNearbyExhibitions(lat, lon) {
  const serviceKey = encodeURIComponent('lphwkq+F/LhC5uXApG5bWPqWGQqXsEN3U73ivOt8MpLZjeL2ocdUj4xD/MWxqw6/V7rVnQMJWwcIgcyZvFanPA==');

  const deltaLat = 10 / 111.32;
  const deltaLon = 10 / (111.32 * Math.cos(lat * Math.PI / 180));
  const gpsxfrom = (lon - deltaLon).toFixed(6);
  const gpsxto = (lon + deltaLon).toFixed(6);
  const gpsyfrom = (lat - deltaLat).toFixed(6);
  const gpsyto = (lat + deltaLat).toFixed(6);

  const url = `https://apis.data.go.kr/B553457/nopenapi/rest/cultureartspaces/artgallery?serviceKey=${serviceKey}&PageNo=1&numOfrows=100&gpsxfrom=${gpsxfrom}&gpsxto=${gpsxto}&gpsyfrom=${gpsyfrom}&gpsyto=${gpsyto}`;

  fetch(url)
    .then(res => res.text())
    .then(str => (new DOMParser()).parseFromString(str, "text/xml"))
    .then(data => {
      const items = Array.from(data.getElementsByTagName('item'));

      const nearby = items.map(item => {
        const name = item.getElementsByTagName('culName')[0]?.textContent || '전시관';
        const x = parseFloat(item.getElementsByTagName('gpsX')[0]?.textContent);
        const y = parseFloat(item.getElementsByTagName('gpsY')[0]?.textContent);
        const tel = item.getElementsByTagName('culTel')[0]?.textContent || '';
        const url = item.getElementsByTagName('culHomeUrl')[0]?.textContent || '';
        const distance = getDistanceFromLatLonInKm(lat, lon, y, x);
        return { name, x, y, tel, url, distance };
      }).filter(p => !isNaN(p.x) && !isNaN(p.y))
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 7);

      if (nearby.length === 0) {
        showMessage('주변 10km 이내에 전시관이 없습니다.');
        return;
      }

      let customOverlay = new kakao.maps.CustomOverlay({ zIndex: 20 });

      nearby.forEach(place => {
        const marker = new kakao.maps.Marker({
          map,
          position: new kakao.maps.LatLng(place.y, place.x),
          title: place.name,
          image: new kakao.maps.MarkerImage(
            'https://cdn-icons-png.flaticon.com/512/14034/14034740.png',
            new kakao.maps.Size(100, 100),
            { offset: new kakao.maps.Point(14, 14) }
          )
        });

        const content = document.createElement('div');
        content.innerHTML = `
          <div style="
            background: #f5f5dc;
            padding: 20px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: 'Inter', sans-serif;
            max-width: 500px;
            max-height: 300px;
            font-size: 25px;
            line-height: 2.5;
          ">
            <div><strong>이름:</strong> ${place.name}</div>
            ${place.tel ? `<div><strong>전화번호:</strong> ${place.tel}</div>` : ''}
            ${place.url ? `<div><strong>홈페이지</strong><br><a href="${place.url}" target="_blank" style="color: #0066cc; text-decoration: underline; cursor: pointer;">${place.url}</a></div>` : ''}
          </div>
        `;

        // 링크 클릭 이벤트 리스너 추가
        const linkElement = content.querySelector('a');
        if (linkElement) {
          linkElement.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const url = this.getAttribute('href');
            if (window.flutter_inappwebview) {
              window.flutter_inappwebview.callHandler('openLink', url);
            } else {
              window.open(url, '_blank');
            }
          });
        }
        content.addEventListener('click', function(event) {
          event.stopPropagation(); // 말풍선 클릭 시 오버레이 닫기 방지
});

        kakao.maps.event.addListener(marker, 'click', () => {
          customOverlay.setMap(null);
          customOverlay.setContent(content);
          customOverlay.setPosition(new kakao.maps.LatLng(place.y, place.x));
          customOverlay.setMap(map);
        });
      });

      kakao.maps.event.addListener(map, 'click', function () {
        customOverlay.setMap(null);
      });
    });
}

function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
  const R = 6371; // km 단위
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
    Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
function deg2rad(deg) {
  return deg * (Math.PI / 180);
}

    // 현재 위치로 지도를 이동하는 함수
    function moveToCurrentLocation() {
  if (currentPos) {
    map.setCenter(currentPos);
    showMessage('현재 위치로 이동했습니다.');
  } else if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      currentPos = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
      map.setCenter(currentPos);

      new kakao.maps.Marker({
        map,
        position: currentPos,
        title: '현재 위치',
        image: new kakao.maps.MarkerImage(
          'https://cdn-icons-png.flaticon.com/512/684/684908.png',
          new kakao.maps.Size(50, 50),
          { offset: new kakao.maps.Point(15, 15) }
        )
      });

      showMessage('현재 위치로 이동했습니다.');
      searchNearbyExhibitions(position.coords.latitude, position.coords.longitude);

    }, onLocationError, {
      enableHighAccuracy: true,
      maximumAge: 300000,
      timeout: 30000
    });
  } else {
    showMessage('현재 브라우저에서는 위치 정보를 지원하지 않습니다.');
  }
}

    window.onFlutterLocation = function(lat, lon) {
      // lat, lon을 받아서 지도 중심 이동 등 처리
      // 예: map.setCenter(new kakao.maps.LatLng(lat, lon));
    };
  </script>
</body>
</html>