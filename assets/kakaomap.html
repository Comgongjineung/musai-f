<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>전시 지도</title>
  <!-- Tailwind CSS CDN을 추가하여 UI를 깔끔하게 만듭니다. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4e3d5fd0af4f53faefab49b87d79a11d&libraries=services&autoload=false"></script>
  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      font-family: 'Inter', sans-serif; /* Tailwind의 Inter 폰트 사용 */
    }
    #map { 
      width: 100%; 
      height: 100%; 
      border-radius: 16px; /* 둥근 모서리 적용 */
      overflow: hidden; /* 둥근 모서리 내부 콘텐츠 클리핑 */
    }
    #moveCurrent {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: white;
      border-radius: 50%;
      padding: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.4); /* 그림자 효과 강화 */
      cursor: pointer;
      z-index: 10;
      display: flex; /* 아이콘 중앙 정렬 */
      align-items: center;
      justify-content: center;
      transition: transform 0.2s; /* 호버 애니메이션 */
    }
    #moveCurrent:active {
      transform: scale(0.95); /* 클릭 시 스케일 축소 */
    }
    /* 커스텀 메시지 박스 스타일 */
    .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        text-align: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    .message-box.show {
        opacity: 1;
        visibility: visible;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="moveCurrent" onclick="moveToCurrentLocation()">
    <!-- 구글 아이콘을 SVG로 직접 포함하여 외부 의존성 제거 및 스타일링 유연성 확보 -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="text-gray-700">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
  </div>
  <div id="messageBox" class="message-box"></div>

  <script>
    let map;
    let currentPos = null;
    let ps;
    const messageBox = document.getElementById('messageBox');

    // 메시지를 표시하는 함수
    function showMessage(message, duration = 3000) {
        messageBox.textContent = message;
        messageBox.classList.add('show');
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, duration);
    }

    kakao.maps.load(() => {
      const mapContainer = document.getElementById('map');
      const mapOptions = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청 기본 위치
        level: 5
      };
      map = new kakao.maps.Map(mapContainer, mapOptions);
      ps = new kakao.maps.services.Places();

      if (navigator.geolocation) {
        // 위치 정보 옵션 강화 (정확도 높임, 캐시 사용 최소화)
        navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, {
          enableHighAccuracy: true,
          maximumAge: 300000, // 5분 이내 캐시된 위치 정보는 재사용
          timeout: 30000 // 30초 내에 응답 없으면 타임아웃
        });
      } else {
        console.error('이 브라우저는 위치 정보를 지원하지 않습니다.');
        showMessage('현재 브라우저에서는 위치 정보를 지원하지 않습니다.');
      }
    });

    function onLocationSuccess(position) {
      currentPos = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
      map.setCenter(currentPos);

      // 현재 위치 마커 아이콘 변경 (더 눈에 잘 띄는 아이콘으로)
      new kakao.maps.Marker({
        map,
        position: currentPos,
        title: '현재 위치',
        image: new kakao.maps.MarkerImage(
          'https://cdn-icons-png.flaticon.com/512/684/684908.png', // 더 일반적인 위치 아이콘
          new kakao.maps.Size(30, 30),
          { offset: new kakao.maps.Point(15, 15) }
        )
      });

      // 현재 위치를 기준으로 주변 전시회 검색
      searchNearbyExhibitions(position.coords.latitude, position.coords.longitude);
    }

    function onLocationError(error) {
      let message = '';
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = '위치 권한이 거부되었습니다. 앱 설정에서 권한을 허용해주세요.';
          break;
        case error.POSITION_UNAVAILABLE:
          message = '기기의 위치 정보를 사용할 수 없습니다. (GPS 비활성화 등)';
          break;
        case error.TIMEOUT:
          message = '위치 요청 시간이 초과되었습니다. 네트워크 상태를 확인해주세요.';
          break;
        default:
          message = `알 수 없는 위치 오류입니다. 코드: ${error.code}`;
      }
      console.error(`[KakaoMap HTML] 위치 오류 (${error.code}): ${error.message} - ${message}`);
      showMessage(`현재 위치를 가져올 수 없습니다.\n사유: ${message}`);
    }

    function searchNearbyExhibitions(lat, lon) {
      ps.keywordSearch('전시', (data, status, pagination) => {
        if (status === kakao.maps.services.Status.OK) {
          data.forEach(place => {
            const marker = new kakao.maps.Marker({
              map,
              position: new kakao.maps.LatLng(place.y, place.x),
              title: place.place_name,
              image: new kakao.maps.MarkerImage(
                'https://cdn-icons-png.flaticon.com/512/854/854878.png',
                new kakao.maps.Size(28, 28),
                { offset: new kakao.maps.Point(14, 14) }
              )
            });
            const infoWindow = new kakao.maps.InfoWindow({
              content: `<div style="padding:5px;font-size:13px;font-family: 'Inter', sans-serif;">${place.place_name}</div>`
            });
            kakao.maps.event.addListener(marker, 'click', () => {
              infoWindow.open(map, marker);
            });
          });
          if (data.length === 0) {
             console.log('근처에 전시 장소가 없습니다.');
             showMessage('현재 위치 근처에 전시 장소가 없습니다.');
          }
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
          console.log('근처에 전시 장소가 없습니다.');
          showMessage('근처에 전시 장소가 없습니다.');
        } else {
          console.error(`[KakaoMap HTML] 검색 오류: ${status}`);
          showMessage(`전시 장소 검색 오류가 발생했습니다. 상태: ${status}`);
        }
      }, {
        location: new kakao.maps.LatLng(lat, lon),
        radius: 3000 // 3km 반경 내 검색
      });
    }

    function moveToCurrentLocation() {
      if (currentPos) {
        map.setCenter(currentPos);
        showMessage('현재 위치로 이동했습니다.');
      } else {
        console.error('현재 위치를 불러올 수 없습니다. 위치 권한을 확인하거나 다시 시도해주세요.');
        showMessage('현재 위치를 불러올 수 없습니다.');
      }
    }
  </script>
</body>
</html>
